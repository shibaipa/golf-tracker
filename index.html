<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Golf Round Tracker</title>

  <!-- （CodePenでは無視されてもOKなPWA関連） -->
  <link rel="manifest" href="/golf-tracker_nonPWA/manifest.webmanifest">
  <meta name="theme-color" content="#10b981">
  <link rel="apple-touch-icon" href="/golf-tracker_nonPWA/icons/apple-touch-icon.png">
  <link rel="icon" href="/golf-tracker_nonPWA/icons/icon-192.png" sizes="192x192">
  <link rel="icon" href="/golf-tracker_nonPWA/icons/icon-512.png" sizes="512x512">

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html{font-family: ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    body::-webkit-scrollbar{display:none}
    body{-ms-overflow-style:none;scrollbar-width:none}
    .btn-toggle{border-width:2px;border-radius:.5rem;padding:.375rem .5rem;display:inline-flex;align-items:center;justify-content:center;font-weight:600}
    .btn-toggle.on{background:#10b981;color:white;border-color:#10b981}
    .pill{border:1px solid #e5e7eb;border-radius:9999px;padding:.25rem .5rem;font-size:.75rem;cursor:pointer;user-select:none}
    .pill.on{background:#10b981;color:white;border-color:#10b981}
    .score-ok{color:#059669;font-weight:600}
    .score-ng{color:#dc2626;font-weight:600}
    .grid-head{font-size:.65rem;color:#6b7280}
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-2 sm:p-4">
  <div id="app" class="max-w-5xl mx-auto">

    <!-- ===== View: OVERVIEW ===== -->
    <section id="view-overview" class="space-y-4">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">Rounds</h1>
        <button id="btn-new-round" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition">New Round</button>
      </div>
      <div id="rounds-list" class="grid md:grid-cols-2 gap-3"></div>
    </section>

    <!-- ===== View: SETUP ===== -->
    <section id="view-setup" class="hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-bold" id="setup-title">New Round Setup</h2>
        <div class="space-x-2">
          <button id="btn-setup-cancel" class="px-3 py-2 border rounded-lg hover:bg-gray-100">Back</button>
          <button id="btn-setup-save" class="px-4 py-2 bg-emerald-600 text-white rounded-lg shadow hover:bg-emerald-700">Start Tracker</button>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <!-- Basic -->
        <div class="md:col-span-1 space-y-3 p-4 bg-white rounded-xl shadow">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Date</label>
            <input type="date" id="setup-date" class="w-full p-2 border rounded-md"/>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Course</label>
            <input type="text" id="setup-course" class="w-full p-2 border rounded-md" placeholder="e.g. Fuji CC"/>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">Start Order</label>
            <div class="flex gap-2">
              <button type="button" class="btn-toggle" id="btn-start-out" data-start="OUT">OUT</button>
              <button type="button" class="btn-toggle" id="btn-start-in" data-start="IN">IN</button>
            </div>
            <p class="text-xs text-gray-500 mt-1">OUT: 1→9→10→18 / IN: 10→18→1→9</p>
          </div>
          <div class="pt-2 border-t">
            <div class="text-sm grid grid-cols-2 gap-2">
              <div>Par Total</div><div class="text-right font-bold" id="setup-par-total">72</div>
              <div>Target Total</div><div class="text-right font-bold" id="setup-target-total">90</div>
              <div class="col-span-2 text-xs text-gray-500">Target Total = Σ (Par + TargetAdj)</div>
            </div>
          </div>
        </div>

        <!-- Par & Target per hole -->
        <div class="md:col-span-2 p-4 bg-white rounded-xl shadow">
          <div class="flex items-baseline justify-between mb-2">
            <h3 class="font-semibold">Holes (Par & Target)</h3>
            <div class="grid-head">Target: Par / Bogey / D.Bogey</div>
          </div>
          <div id="par-input-grid"></div>
        </div>
      </div>
    </section>

    <!-- ===== View: TRACKER ===== -->
    <section id="view-tracker" class="hidden">
      <div class="flex items-center justify-between mb-3">
        <div class="space-x-2">
          <button id="btn-tracker-back" class="px-3 py-2 border rounded-lg hover:bg-gray-100">Back</button>
          <button id="btn-open-scorecard" class="px-3 py-2 border rounded-lg hover:bg-gray-100">Scorecard</button>
        </div>
        <div class="text-right">
          <div class="text-xs text-gray-500">TOTAL</div>
          <div class="text-3xl font-extrabold" id="round-total">0</div>
          <div class="mt-1 grid grid-cols-3 gap-2 text-xs">
            <div>
              <div class="text-gray-500">vs Par</div>
              <div class="text-lg font-bold" id="round-vspar">E</div>
            </div>
            <div>
              <div class="text-gray-500">vs Target</div>
              <div class="text-lg font-bold" id="round-vstarget">E</div>
            </div>
            <div>
              <div class="text-gray-500">Total Target</div>
              <div class="text-lg font-bold" id="round-total-target">0</div>
            </div>
          </div>
        </div>
      </div>

      <div class="p-4 bg-white rounded-xl shadow">
        <div class="flex items-center justify-between">
          <div class="text-xl font-bold" id="hole-title">Hole 1 (Par 4)</div>
          <div class="space-x-2">
            <button id="btn-prev-hole" class="px-3 py-2 bg-gray-200 rounded-lg">Prev</button>
            <button id="btn-next-hole" class="px-3 py-2 bg-gray-200 rounded-lg">Next</button>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-4 mt-4">
        <!-- 0. Target -->
        <div class="p-3 rounded-lg border">
          <div class="text-sm font-semibold mb-2">Target</div>
          <div class="grid grid-cols-3 gap-2 text-xs">
            <button type="button" class="btn-toggle" id="tg-par">Par</button>
            <button type="button" class="btn-toggle" id="tg-bogey">Bogey</button>
            <button type="button" class="btn-toggle" id="tg-dbogey">D.Bogey</button>
          </div>
        </div>

        <!-- 1. Tee -->
        <div class="p-3 rounded-lg border">
          <div class="text-sm font-semibold mb-2">Tee Shot</div>
          <label class="block text-xs text-gray-600 mb-1">Club</label>
          <select id="tee-club" class="w-full p-2 border rounded-md">
            <option>1W</option><option>4U</option><option>5i</option><option>6i</option><option>7i</option><option>8i</option><option>9i</option><option>PW</option><option>48°</option><option>52°</option><option>56°</option>
          </select>

          <div class="grid grid-cols-3 gap-2 mt-3 text-center text-xs font-semibold">
            <label class="pill tee-res-opt" data-value="Stay Course">Stay</label>
            <label class="pill tee-res-opt" data-value="Penalty">Penalty</label>
            <label class="pill tee-res-opt" data-value="OB">OB</label>
          </div>
          <div class="grid grid-cols-5 gap-1 mt-2 text-center text-xs">
            <label class="pill tee-dir-opt" data-value="Straight">Straight</label>
            <label class="pill tee-dir-opt" data-value="Over">Over</label>
            <label class="pill tee-dir-opt" data-value="Short">Short</label>
            <label class="pill tee-dir-opt" data-value="Left">Left</label>
            <label class="pill tee-dir-opt" data-value="Right">Right</label>
          </div>
        </div>

        <!-- 2. Scoring Zone（To SZ / SZ to G / Putts） -->
        <div class="p-3 rounded-lg border">
          <div class="text-sm font-semibold mb-2">Scoring Zone</div>
          <!-- To SZ -->
          <div class="mb-2">
            <div class="flex items-center justify-between border rounded-md">
              <button type="button" data-key="strokesToSZ" data-act="-" class="p-3 bg-yellow-100 rounded-l-md text-xl">-</button>
              <div class="flex-1 text-center p-2">
                <div class="text-xs text-gray-500">To SZ</div>
                <div id="disp-to" class="text-2xl font-bold">0</div>
                <div class="text-xs text-gray-500">(T=<span id="target-to">0</span>)</div>
                <div class="text-xs mt-1"><span id="ok-to" class="font-bold"></span></div>
              </div>
              <button type="button" data-key="strokesToSZ" data-act="+" class="p-3 bg-yellow-100 rounded-r-md text-xl">+</button>
            </div>
          </div>
          <!-- SZ to G -->
          <div class="mb-2">
            <div class="flex items-center justify-between border rounded-md">
              <button type="button" data-key="strokesFromSZ" data-act="-" class="p-3 bg-yellow-100 rounded-l-md text-xl">-</button>
              <div class="flex-1 text-center p-2">
                <div class="text-xs text-gray-500">SZ to G</div>
                <div id="disp-from" class="text-2xl font-bold">0</div>
                <div class="text-xs text-gray-500">(T=<span id="target-from">0</span>)</div>
                <div class="text-xs mt-1"><span id="ok-from" class="font-bold"></span></div>
              </div>
              <button type="button" data-key="strokesFromSZ" data-act="+" class="p-3 bg-yellow-100 rounded-r-md text-xl">+</button>
            </div>
          </div>
          <!-- Putts (G to HO) -->
          <div>
            <div class="flex items-center justify-between border rounded-md">
              <button type="button" data-key="putts" data-act="-" class="p-3 bg-yellow-100 rounded-l-md text-xl">-</button>
              <div class="flex-1 text-center p-2">
                <div class="text-xs text-gray-500">Putts</div>
                <div id="disp-gtoho" class="text-2xl font-bold">0</div>
                <div class="text-xs text-gray-500">(T=<span id="target-gtoho">2</span>)</div>
                <div class="text-xs mt-1"><span id="ok-gtoho" class="font-bold"></span></div>
              </div>
              <button type="button" data-key="putts" data-act="+" class="p-3 bg-yellow-100 rounded-r-md text-xl">+</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Result (override) -->
      <div class="mt-4">
        <div class="p-3 rounded-lg border">
          <div class="text-sm font-semibold mb-2">Result</div>
          <div class="flex items-center justify-between border rounded-md">
            <button type="button" data-key="resultOverride" data-act="-" class="p-3 bg-gray-100 rounded-l-md text-xl">-</button>
            <div class="flex-1 text-center p-2">
              <div class="text-xs text-gray-500">Result (override)</div>
              <div>
                <div id="disp-result" class="text-2xl font-bold inline-block"></div>
                <span id="disp-result-label" class="text-sm text-gray-500 ml-1"></span>
              </div>
              <div class="text-xs mt-1"><span id="result-warning" class="font-bold"></span></div>
            </div>
            <button type="button" data-key="resultOverride" data-act="+" class="p-3 bg-gray-100 rounded-r-md text-xl">+</button>
          </div>
          <div class="text-xs text-gray-500 mt-1">
            If set, scorecard uses this value. Mismatch with (To SZ + SZ to G + Putts) shows a warning.
          </div>
        </div>
      </div>

      <!-- SZ to G detail (Shot1〜3) -->
      <div class="mt-4">
        <div class="p-3 rounded-lg border">
          <div class="text-sm font-semibold mb-2">SZ to G detail</div>

          <!-- Shot 1 -->
          <div class="mb-4">
            <div class="text-xs font-semibold mb-1">Shot 1</div>
            <div class="grid md:grid-cols-3 gap-2 mb-2">
              <div>
                <div class="text-xs text-gray-500 mb-1">Target yard</div>
                <select id="szshot1-target" class="w-full p-2 border rounded-md szdetail-select" data-shot="1" data-field="targetYard"></select>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Club</div>
                <select id="szshot1-club" class="w-full p-2 border rounded-md szdetail-select" data-shot="1" data-field="club">
                  <option value=""></option>
                  <option value="PW">PW</option>
                  <option value="56">56</option>
                  <option value="50">50</option>
                  <option value="Putter">Putter</option>
                  <option value="52">52</option>
                  <option value="8I">8I</option>
                  <option value="9I">9I</option>
                </select>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Actual yard</div>
                <select id="szshot1-actual" class="w-full p-2 border rounded-md szdetail-select" data-shot="1" data-field="actualYard"></select>
              </div>
            </div>
            <div class="text-xs text-gray-500 mb-1">Outcomes</div>
            <div class="grid grid-cols-5 gap-1 text-xs text-center mb-1">
              <label class="pill szdetail-outcome" data-shot="1" data-val="Short">Short</label>
              <label class="pill szdetail-outcome" data-shot="1" data-val="Straight">Straight</label>
              <label class="pill szdetail-outcome" data-shot="1" data-val="Over">Over</label>
              <label class="pill szdetail-outcome" data-shot="1" data-val="Left">Left</label>
              <label class="pill szdetail-outcome" data-shot="1" data-val="Right">Right</label>
            </div>
            <div class="grid grid-cols-6 gap-1 text-xs text-center">
              <label class="pill szdetail-outcome" data-shot="1" data-val="OB">OB</label>
              <label class="pill szdetail-outcome" data-shot="1" data-val="Penalty">Penalty</label>
              <label class="pill szdetail-outcome" data-shot="1" data-val="Bunker">Bunker</label>
              <label class="pill szdetail-outcome" data-shot="1" data-val="Topped">Topped</label>
              <label class="pill szdetail-outcome" data-shot="1" data-val="Heavy Duff">Heavy Duff</label>
              <label class="pill szdetail-outcome" data-shot="1" data-val="Shank">Shank</label>
            </div>
          </div>

          <!-- Shot 2 -->
          <div class="mb-4">
            <div class="text-xs font-semibold mb-1">Shot 2</div>
            <div class="grid md:grid-cols-3 gap-2 mb-2">
              <div>
                <div class="text-xs text-gray-500 mb-1">Target yard</div>
                <select id="szshot2-target" class="w-full p-2 border rounded-md szdetail-select" data-shot="2" data-field="targetYard"></select>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Club</div>
                <select id="szshot2-club" class="w-full p-2 border rounded-md szdetail-select" data-shot="2" data-field="club">
                  <option value=""></option>
                  <option value="PW">PW</option>
                  <option value="56">56</option>
                  <option value="50">50</option>
                  <option value="Putter">Putter</option>
                  <option value="52">52</option>
                  <option value="8I">8I</option>
                  <option value="9I">9I</option>
                </select>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Actual yard</div>
                <select id="szshot2-actual" class="w-full p-2 border rounded-md szdetail-select" data-shot="2" data-field="actualYard"></select>
              </div>
            </div>
            <div class="text-xs text-gray-500 mb-1">Outcomes</div>
            <div class="grid grid-cols-5 gap-1 text-xs text-center mb-1">
              <label class="pill szdetail-outcome" data-shot="2" data-val="Short">Short</label>
              <label class="pill szdetail-outcome" data-shot="2" data-val="Straight">Straight</label>
              <label class="pill szdetail-outcome" data-shot="2" data-val="Over">Over</label>
              <label class="pill szdetail-outcome" data-shot="2" data-val="Left">Left</label>
              <label class="pill szdetail-outcome" data-shot="2" data-val="Right">Right</label>
            </div>
            <div class="grid grid-cols-6 gap-1 text-xs text-center">
              <label class="pill szdetail-outcome" data-shot="2" data-val="OB">OB</label>
              <label class="pill szdetail-outcome" data-shot="2" data-val="Penalty">Penalty</label>
              <label class="pill szdetail-outcome" data-shot="2" data-val="Bunker">Bunker</label>
              <label class="pill szdetail-outcome" data-shot="2" data-val="Topped">Topped</label>
              <label class="pill szdetail-outcome" data-shot="2" data-val="Heavy Duff">Heavy Duff</label>
              <label class="pill szdetail-outcome" data-shot="2" data-val="Shank">Shank</label>
            </div>
          </div>

          <!-- Shot 3 -->
          <div>
            <div class="text-xs font-semibold mb-1">Shot 3</div>
            <div class="grid md:grid-cols-3 gap-2 mb-2">
              <div>
                <div class="text-xs text-gray-500 mb-1">Target yard</div>
                <select id="szshot3-target" class="w-full p-2 border rounded-md szdetail-select" data-shot="3" data-field="targetYard"></select>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Club</div>
                <select id="szshot3-club" class="w-full p-2 border rounded-md szdetail-select" data-shot="3" data-field="club">
                  <option value=""></option>
                  <option value="PW">PW</option>
                  <option value="56">56</option>
                  <option value="50">50</option>
                  <option value="Putter">Putter</option>
                  <option value="52">52</option>
                  <option value="8I">8I</option>
                  <option value="9I">9I</option>
                </select>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Actual yard</div>
                <select id="szshot3-actual" class="w-full p-2 border rounded-md szdetail-select" data-shot="3" data-field="actualYard"></select>
              </div>
            </div>
            <div class="text-xs text-gray-500 mb-1">Outcomes</div>
            <div class="grid grid-cols-5 gap-1 text-xs text-center mb-1">
              <label class="pill szdetail-outcome" data-shot="3" data-val="Short">Short</label>
              <label class="pill szdetail-outcome" data-shot="3" data-val="Straight">Straight</label>
              <label class="pill szdetail-outcome" data-shot="3" data-val="Over">Over</label>
              <label class="pill szdetail-outcome" data-shot="3" data-val="Left">Left</label>
              <label class="pill szdetail-outcome" data-shot="3" data-val="Right">Right</label>
            </div>
            <div class="grid grid-cols-6 gap-1 text-xs text-center">
              <label class="pill szdetail-outcome" data-shot="3" data-val="OB">OB</label>
              <label class="pill szdetail-outcome" data-shot="3" data-val="Penalty">Penalty</label>
              <label class="pill szdetail-outcome" data-shot="3" data-val="Bunker">Bunker</label>
              <label class="pill szdetail-outcome" data-shot="3" data-val="Topped">Topped</label>
              <label class="pill szdetail-outcome" data-shot="3" data-val="Heavy Duff">Heavy Duff</label>
              <label class="pill szdetail-outcome" data-shot="3" data-val="Shank">Shank</label>
            </div>
          </div>

        </div>
      </div>

      <!-- Putt Detail -->
      <div class="mt-4">
        <div class="p-3 rounded-lg border">
          <div class="text-sm font-semibold mb-2">Putt Detail</div>

          <!-- Putt 1 -->
          <div class="mb-4">
            <div class="text-xs font-semibold mb-1">Putt 1</div>
            <div class="grid md:grid-cols-3 gap-2 mb-2">
              <div>
                <div class="text-xs text-gray-500 mb-1">Target yard</div>
                <select id="putt1-target" class="w-full p-2 border rounded-md puttdetail-select" data-putt="1" data-field="targetYard"></select>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Result</div>
                <div class="grid grid-cols-3 gap-1 text-xs text-center">
                  <label class="pill puttdetail-result" data-putt="1" data-val="In">In (holed)</label>
                  <label class="pill puttdetail-result" data-putt="1" data-val="Tap-in">Tap-in (next OK)</label>
                  <label class="pill puttdetail-result" data-putt="1" data-val="Short miss">Short miss</label>
                  <label class="pill puttdetail-result" data-putt="1" data-val="Long miss">Long miss</label>
                  <label class="pill puttdetail-result" data-putt="1" data-val="Left miss">Left miss</label>
                  <label class="pill puttdetail-result" data-putt="1" data-val="Right miss">Right miss</label>
                  <label class="pill puttdetail-result" data-putt="1" data-val="Lip-out">Lip-out</label>
                </div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Stroke</div>
                <div class="grid grid-cols-3 gap-1 text-xs text-center">
                  <label class="pill puttdetail-stroke" data-putt="1" data-val="Straight (on line)">Straight (on line)</label>
                  <label class="pill puttdetail-stroke" data-putt="1" data-val="Push right">Push right</label>
                  <label class="pill puttdetail-stroke" data-putt="1" data-val="Push left">Push left</label>
                  <label class="pill puttdetail-stroke" data-putt="1" data-val="Short">Short</label>
                  <label class="pill puttdetail-stroke" data-putt="1" data-val="Over">Over</label>
                </div>
              </div>
            </div>
            <div class="text-xs text-gray-500 mb-1">Read (Green Read)</div>
            <div class="grid grid-cols-3 gap-1 text-xs text-center">
              <label class="pill puttdetail-read" data-putt="1" data-val="Too much R">Too much R</label>
              <label class="pill puttdetail-read" data-putt="1" data-val="R OK">R OK</label>
              <label class="pill puttdetail-read" data-putt="1" data-val="Too little R">Too little R</label>
              <label class="pill puttdetail-read" data-putt="1" data-val="Too much L">Too much L</label>
              <label class="pill puttdetail-read" data-putt="1" data-val="L OK">L OK</label>
              <label class="pill puttdetail-read" data-putt="1" data-val="Too little L">Too little L</label>
            </div>
          </div>

          <!-- Putt 2 -->
          <div class="mb-4">
            <div class="text-xs font-semibold mb-1">Putt 2</div>
            <div class="grid md:grid-cols-3 gap-2 mb-2">
              <div>
                <div class="text-xs text-gray-500 mb-1">Target yard</div>
                <select id="putt2-target" class="w-full p-2 border rounded-md puttdetail-select" data-putt="2" data-field="targetYard"></select>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Result</div>
                <div class="grid grid-cols-3 gap-1 text-xs text-center">
                  <label class="pill puttdetail-result" data-putt="2" data-val="In">In (holed)</label>
                  <label class="pill puttdetail-result" data-putt="2" data-val="Tap-in">Tap-in (next OK)</label>
                  <label class="pill puttdetail-result" data-putt="2" data-val="Short miss">Short miss</label>
                  <label class="pill puttdetail-result" data-putt="2" data-val="Long miss">Long miss</label>
                  <label class="pill puttdetail-result" data-putt="2" data-val="Left miss">Left miss</label>
                  <label class="pill puttdetail-result" data-putt="2" data-val="Right miss">Right miss</label>
                  <label class="pill puttdetail-result" data-putt="2" data-val="Lip-out">Lip-out</label>
                </div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Stroke</div>
                <div class="grid grid-cols-3 gap-1 text-xs text-center">
                  <label class="pill puttdetail-stroke" data-putt="2" data-val="Straight (on line)">Straight (on line)</label>
                  <label class="pill puttdetail-stroke" data-putt="2" data-val="Push right">Push right</label>
                  <label class="pill puttdetail-stroke" data-putt="2" data-val="Push left">Push left</label>
                  <label class="pill puttdetail-stroke" data-putt="2" data-val="Short">Short</label>
                  <label class="pill puttdetail-stroke" data-putt="2" data-val="Over">Over</label>
                </div>
              </div>
            </div>
            <div class="text-xs text-gray-500 mb-1">Read (Green Read)</div>
            <div class="grid grid-cols-3 gap-1 text-xs text-center">
              <label class="pill puttdetail-read" data-putt="2" data-val="Too much R">Too much R</label>
              <label class="pill puttdetail-read" data-putt="2" data-val="R OK">R OK</label>
              <label class="pill puttdetail-read" data-putt="2" data-val="Too little R">Too little R</label>
              <label class="pill puttdetail-read" data-putt="2" data-val="Too much L">Too much L</label>
              <label class="pill puttdetail-read" data-putt="2" data-val="L OK">L OK</label>
              <label class="pill puttdetail-read" data-putt="2" data-val="Too little L">Too little L</label>
            </div>
          </div>

          <!-- Putt 3 -->
          <div class="mb-4">
            <div class="text-xs font-semibold mb-1">Putt 3</div>
            <div class="grid md:grid-cols-3 gap-2 mb-2">
              <div>
                <div class="text-xs text-gray-500 mb-1">Target yard</div>
                <select id="putt3-target" class="w-full p-2 border rounded-md puttdetail-select" data-putt="3" data-field="targetYard"></select>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Result</div>
                <div class="grid grid-cols-3 gap-1 text-xs text-center">
                  <label class="pill puttdetail-result" data-putt="3" data-val="In">In (holed)</label>
                  <label class="pill puttdetail-result" data-putt="3" data-val="Tap-in">Tap-in (next OK)</label>
                  <label class="pill puttdetail-result" data-putt="3" data-val="Short miss">Short miss</label>
                  <label class="pill puttdetail-result" data-putt="3" data-val="Long miss">Long miss</label>
                  <label class="pill puttdetail-result" data-putt="3" data-val="Left miss">Left miss</label>
                  <label class="pill puttdetail-result" data-putt="3" data-val="Right miss">Right miss</label>
                  <label class="pill puttdetail-result" data-putt="3" data-val="Lip-out">Lip-out</label>
                </div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Stroke</div>
                <div class="grid grid-cols-3 gap-1 text-xs text-center">
                  <label class="pill puttdetail-stroke" data-putt="3" data-val="Straight (on line)">Straight (on line)</label>
                  <label class="pill puttdetail-stroke" data-putt="3" data-val="Push right">Push right</label>
                  <label class="pill puttdetail-stroke" data-putt="3" data-val="Push left">Push left</label>
                  <label class="pill puttdetail-stroke" data-putt="3" data-val="Short">Short</label>
                  <label class="pill puttdetail-stroke" data-putt="3" data-val="Over">Over</label>
                </div>
              </div>
            </div>
            <div class="text-xs text-gray-500 mb-1">Read (Green Read)</div>
            <div class="grid grid-cols-3 gap-1 text-xs text-center">
              <label class="pill puttdetail-read" data-putt="3" data-val="Too much R">Too much R</label>
              <label class="pill puttdetail-read" data-putt="3" data-val="R OK">R OK</label>
              <label class="pill puttdetail-read" data-putt="3" data-val="Too little R">Too little R</label>
              <label class="pill puttdetail-read" data-putt="3" data-val="Too much L">Too much L</label>
              <label class="pill puttdetail-read" data-putt="3" data-val="L OK">L OK</label>
              <label class="pill puttdetail-read" data-putt="3" data-val="Too little L">Too little L</label>
            </div>
          </div>

          <!-- Putt 4 -->
          <div>
            <div class="text-xs font-semibold mb-1">Putt 4</div>
            <div class="grid md:grid-cols-3 gap-2 mb-2">
              <div>
                <div class="text-xs text-gray-500 mb-1">Target yard</div>
                <select id="putt4-target" class="w-full p-2 border rounded-md puttdetail-select" data-putt="4" data-field="targetYard"></select>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Result</div>
                <div class="grid grid-cols-3 gap-1 text-xs text-center">
                  <label class="pill puttdetail-result" data-putt="4" data-val="In">In (holed)</label>
                  <label class="pill puttdetail-result" data-putt="4" data-val="Tap-in">Tap-in (next OK)</label>
                  <label class="pill puttdetail-result" data-putt="4" data-val="Short miss">Short miss</label>
                  <label class="pill puttdetail-result" data-putt="4" data-val="Long miss">Long miss</label>
                  <label class="pill puttdetail-result" data-putt="4" data-val="Left miss">Left miss</label>
                  <label class="pill puttdetail-result" data-putt="4" data-val="Right miss">Right miss</label>
                  <label class="pill puttdetail-result" data-putt="4" data-val="Lip-out">Lip-out</label>
                </div>
              </div>
              <div>
                <div class="text-xs text-gray-500 mb-1">Stroke</div>
                <div class="grid grid-cols-3 gap-1 text-xs text-center">
                  <label class="pill puttdetail-stroke" data-putt="4" data-val="Straight (on line)">Straight (on line)</label>
                  <label class="pill puttdetail-stroke" data-putt="4" data-val="Push right">Push right</label>
                  <label class="pill puttdetail-stroke" data-putt="4" data-val="Push left">Push left</label>
                  <label class="pill puttdetail-stroke" data-putt="4" data-val="Short">Short</label>
                  <label class="pill puttdetail-stroke" data-putt="4" data-val="Over">Over</label>
                </div>
              </div>
            </div>
            <div class="text-xs text-gray-500 mb-1">Read (Green Read)</div>
            <div class="grid grid-cols-3 gap-1 text-xs text-center">
              <label class="pill puttdetail-read" data-putt="4" data-val="Too much R">Too much R</label>
              <label class="pill puttdetail-read" data-putt="4" data-val="R OK">R OK</label>
              <label class="pill puttdetail-read" data-putt="4" data-val="Too little R">Too little R</label>
              <label class="pill puttdetail-read" data-putt="4" data-val="Too much L">Too much L</label>
              <label class="pill puttdetail-read" data-putt="4" data-val="L OK">L OK</label>
              <label class="pill puttdetail-read" data-putt="4" data-val="Too little L">Too little L</label>
            </div>
          </div>

        </div>
      </div>

      <!-- Other (To SZ only) -->
      <div class="grid md:grid-cols-1 gap-4 mt-4">
        <!-- To SZ Other -->
        <div class="p-3 rounded-lg border">
          <div class="text-sm font-semibold mb-2">Other — To SZ</div>
          <div class="grid md:grid-cols-3 gap-3">
            <div class="border rounded-md p-2 text-center">
              <div class="text-xs text-gray-500">OB</div>
              <div class="flex items-center justify-between">
                <button type="button" data-key="toSZ.ob" data-act="-" class="px-3 py-2 bg-gray-100 rounded">-</button>
                <div id="toSZ-ob" class="text-xl font-bold">0</div>
                <button type="button" data-key="toSZ.ob" data-act="+" class="px-3 py-2 bg-gray-100 rounded">+</button>
              </div>
            </div>
            <div class="border rounded-md p-2 text-center">
              <div class="text-xs text-gray-500">Penalty</div>
              <div class="flex items-center justify-between">
                <button type="button" data-key="toSZ.penalty" data-act="-" class="px-3 py-2 bg-gray-100 rounded">-</button>
                <div id="toSZ-penalty" class="text-xl font-bold">0</div>
                <button type="button" data-key="toSZ.penalty" data-act="+" class="px-3 py-2 bg-gray-100 rounded">+</button>
              </div>
            </div>
            <div class="border rounded-md p-2 text-center">
              <div class="text-xs text-gray-500">Bunker</div>
              <div class="flex items-center justify-between">
                <button type="button" data-key="toSZ.bunker" data-act="-" class="px-3 py-2 bg-gray-100 rounded">-</button>
                <div id="toSZ-bunker" class="text-xl font-bold">0</div>
                <button type="button" data-key="toSZ.bunker" data-act="+" class="px-3 py-2 bg-gray-100 rounded">+</button>
              </div>
            </div>
            <div class="border rounded-md p-2 text-center">
              <div class="text-xs text-gray-500">Topped</div>
              <div class="flex items-center justify-between">
                <button type="button" data-key="toSZ.topped" data-act="-" class="px-3 py-2 bg-gray-100 rounded">-</button>
                <div id="toSZ-topped" class="text-xl font-bold">0</div>
                <button type="button" data-key="toSZ.topped" data-act="+" class="px-3 py-2 bg-gray-100 rounded">+</button>
              </div>
            </div>
            <div class="border rounded-md p-2 text-center">
              <div class="text-xs text-gray-500">Heavy Duff</div>
              <div class="flex items-center justify-between">
                <button type="button" data-key="toSZ.heavyDuff" data-act="-" class="px-3 py-2 bg-gray-100 rounded">-</button>
                <div id="toSZ-heavyDuff" class="text-xl font-bold">0</div>
                <button type="button" data-key="toSZ.heavyDuff" data-act="+" class="px-3 py-2 bg-gray-100 rounded">+</button>
              </div>
            </div>
            <div class="border rounded-md p-2 text-center">
              <div class="text-xs text-gray-500">Shank</div>
              <div class="flex items-center justify-between">
                <button type="button" data-key="toSZ.shank" data-act="-" class="px-3 py-2 bg-gray-100 rounded">-</button>
                <div id="toSZ-shank" class="text-xl font-bold">0</div>
                <button type="button" data-key="toSZ.shank" data-act="+" class="px-3 py-2 bg-gray-100 rounded">+</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Memo -->
      <div class="mt-4">
        <div class="p-3 rounded-lg border">
          <div class="text-sm font-semibold mb-2">Memo</div>
          <textarea id="hole-memo" class="w-full border rounded-md p-2 text-sm" rows="2" placeholder="Notes for this hole..."></textarea>
        </div>
      </div>

    </section>

    <!-- ===== View: SCORECARD ===== -->
    <section id="view-scorecard" class="hidden">
      <div class="flex items-center justify-between mb-3">
        <button id="btn-scorecard-back" class="px-3 py-2 border rounded-lg hover:bg-gray-100">Back</button>
        <div class="text-right">
          <div class="text-xs grid-head">In Progress</div>
          <div id="sc-summary" class="text-sm"></div>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow overflow-x-auto">
        <table class="min-w-full text-sm text-right">
          <thead class="bg-gray-50 text-gray-600 text-right">
            <tr>
              <th class="p-2 text-right">H</th>
              <th class="p-2 text-right">Par</th>
              <th class="p-2 text-right">Target (vs Par)</th>
              <th class="p-2 text-right">To SZ</th>
              <th class="p-2 text-right">SZ to G</th>
              <th class="p-2 text-right">Putts</th>
              <th class="p-2 text-right">Gross</th>
              <th class="p-2 text-right">vs Target</th>
              <th class="p-2 text-right">GIR / +1</th>
            </tr>
          </thead>
          <tbody id="sc-tbody" class="divide-y"></tbody>
        </table>
      </div>
    </section>
  </div>

  <script>
    /* ========== State & Storage ========== */
    const DEFAULT_HOLES = 18, MIN_PAR=3, MAX_PAR=5;
    const idxKey='gr_ids_v3'; const keyFor=(id)=>`gr_${id}_v3`;
    const storage={get:k=>{try{return localStorage.getItem(k)}catch(e){return null}},set:(k,v)=>{try{localStorage.setItem(k,v)}catch(e){}},remove:(k)=>{try{localStorage.removeItem(k)}catch(e){}}};
    const jparse=(s,f)=>{try{return JSON.parse(s)}catch(_){return f}};
    const pm=(v)=> v===0? 'E' : (v>0? `+${v}` : `${v}`);

    const state={
      view:'overview', roundId:null, holeIdx:1,
      round:null, rounds:[],
      parSetup:Array(DEFAULT_HOLES).fill(4),
      startOrder:'OUT',
      editingId:null,
      setupTargets: Array(DEFAULT_HOLES).fill('Bogey')
    };

    const playOrderFor=(start)=> start==='IN'
      ? Array.from({length:9},(_,i)=>10+i).concat(Array.from({length:9},(_,i)=>1+i))
      : Array.from({length:9},(_,i)=>1+i).concat(Array.from({length:9},(_,i)=>10+i));

    function createDefaultSGDetail(){
      return [
        { targetYard:null, club:'', actualYard:null, outcomes:[] },
        { targetYard:null, club:'', actualYard:null, outcomes:[] },
        { targetYard:null, club:'', actualYard:null, outcomes:[] }
      ];
    }

    function createDefaultPuttDetail(){
      return [
        { targetYard:null, stroke:[], result:null, read:null },
        { targetYard:null, stroke:[], result:null, read:null },
        { targetYard:null, stroke:[], result:null, read:null },
        { targetYard:null, stroke:[], result:null, read:null }
      ];
    }

    function createRound(id,date,course,parArr,start,targets){
      const holes=[];
      for(let i=1;i<=DEFAULT_HOLES;i++){
        holes.push({
          hole:i, par:parseInt(parArr[i-1]||4,10),
          teeClub:'1W', teeResult:'Stay Course', teeDirection:'Straight',
          strokesToSZ:0,    // Tee → SZ
          strokesFromSZ:0,  // SZ → G
          putts:0,          // G → HO（Putts）
          resultOverride:null,
          targetGoal: (targets && targets[i-1]) || 'Bogey',
          // split other
          toSZ:{ ob:0, penalty:0, bunker:0, topped:0, heavyDuff:0, shank:0 },
          szToG:{ ob:0, penalty:0, bunker:0, topped:0, heavyDuff:0, shank:0 }, // 互換のため残す（UIでは使わない）
          memo:'',
          sgDetail: createDefaultSGDetail(), // SZ to G detail
          puttDetail: createDefaultPuttDetail() // 修正13: Putt detail
        });
      }
      return {
        roundId:id,
        date:date||new Date().toISOString().slice(0,10),
        courseName:course||'New Course',
        createdAt:new Date().toISOString(),
        holes,
        playStart:start||'OUT',
        playOrder:playOrderFor(start||'OUT'),
        schemaVersion:'v3'
      };
    }

    function save(){
      if(!state.round) return;
      storage.set(keyFor(state.roundId), JSON.stringify(state.round));
      const ids=new Set(jparse(storage.get(idxKey)||'[]',[]));
      ids.add(state.roundId);
      storage.set(idxKey, JSON.stringify([...ids]));
    }

    // Upgrade old schemas to v3 on load
    function upgradeRoundIfNeeded(r){
      if(!r) return r;
      if(!r.playOrder) r.playOrder = playOrderFor(r.playStart||'OUT');

      r.holes.forEach(h=>{
        // old other → split
        if(!h.toSZ || !h.szToG){
          const legacy = { ob:h.ob||0, penalty:h.penalty||0, bunker:h.bunker||0, topped:h.topped||0, heavyDuff:h.heavyDuff||0, shank:h.shank||0 };
          h.toSZ = { ...legacy };
          h.szToG = { ob:0, penalty:0, bunker:0, topped:0, heavyDuff:0, shank:0 };
          delete h.ob; delete h.penalty; delete h.bunker; delete h.topped; delete h.heavyDuff; delete h.shank;
        }
        if(typeof h.memo!=="string") h.memo='';
        if(!Number.isInteger(h.putts)) h.putts = h.putts||0;

        // sgDetail 初期化
        if(!Array.isArray(h.sgDetail)){
          h.sgDetail = createDefaultSGDetail();
        } else {
          const arr = h.sgDetail;
          for(let i=0;i<3;i++){
            if(!arr[i]){
              arr[i] = { targetYard:null, club:'', actualYard:null, outcomes:[] };
            } else {
              if(typeof arr[i].targetYard!=='number') arr[i].targetYard = (arr[i].targetYard==null?null:Number(arr[i].targetYard));
              if(typeof arr[i].actualYard!=='number') arr[i].actualYard = (arr[i].actualYard==null?null:Number(arr[i].actualYard));
              if(typeof arr[i].club!=='string') arr[i].club = '';
              if(!Array.isArray(arr[i].outcomes)) arr[i].outcomes = [];
            }
          }
          h.sgDetail = arr.slice(0,3);
        }

        // 修正13: puttDetail 初期化
        if(!Array.isArray(h.puttDetail)){
          h.puttDetail = createDefaultPuttDetail();
        } else {
          const arr = h.puttDetail;
          for(let i=0;i<4;i++){
            if(!arr[i]){
              arr[i] = { targetYard:null, stroke:[], result:null, read:null };
            } else {
              if(typeof arr[i].targetYard!=='string' && typeof arr[i].targetYard!=='number'){
                arr[i].targetYard = null;
              }
              if(!Array.isArray(arr[i].stroke)) arr[i].stroke = [];
              if(typeof arr[i].result!=='string') arr[i].result = null;
              if(typeof arr[i].read!=='string')   arr[i].read   = null;
            }
          }
          h.puttDetail = arr.slice(0,4);
        }
      });

      r.schemaVersion = 'v3';
      return r;
    }

    function loadRounds(){
      const ids=jparse(storage.get(idxKey)||'[]',[]);
      state.rounds = ids.map(id=>{
        const raw = storage.get(keyFor(id));
        const r = jparse(raw||'null',null);
        return upgradeRoundIfNeeded(r);
      }).filter(Boolean)
        .sort((a,b)=> new Date(b.date)-new Date(a.date));
      // persist any upgrades
      state.rounds.forEach(r=>{ state.round = r; state.roundId = r.roundId; save(); });
      state.round = null; state.roundId = null;
      renderOverview();
    }

    function openRound(id){
      const raw=storage.get(keyFor(id));
      if(!raw){ switchView('overview'); return;}
      state.roundId=id; state.round=upgradeRoundIfNeeded(jparse(raw,null));
      if(!state.round.playOrder) state.round.playOrder=playOrderFor(state.round.playStart||'OUT');
      state.holeIdx=1; save();
      switchView('tracker');
      renderTracker();
    }

    function editRound(id){
      const raw=storage.get(keyFor(id));
      if(!raw){ return; }
      const r=upgradeRoundIfNeeded(jparse(raw,null));
      state.editingId = id;
      state.roundId = id;
      state.round = r;
      state.parSetup = r.holes.map(h=>h.par);
      state.startOrder = r.playStart || 'OUT';
      state.setupTargets = r.holes.map(h=>h.targetGoal || 'Bogey');

      document.getElementById('setup-title').textContent = 'Edit Round';
      document.getElementById('btn-setup-save').textContent = 'Update';
      document.getElementById('setup-date').value = r.date || new Date().toISOString().slice(0,10);
      document.getElementById('setup-course').value = r.courseName || '';
      renderSetup();
      switchView('setup');
    }

    function switchView(v){
      ['overview','setup','tracker','scorecard'].forEach(x=>{
        document.getElementById(`view-${x}`).classList.add('hidden');
      });
      state.view=v;
      document.getElementById(`view-${v}`).classList.remove('hidden');
    }

    /* ========== Targets & Gross Logic ========== */
    function calcTargetsFor(h){
      const adj = (h.targetGoal==='Bogey'?1:(h.targetGoal==='DoubleBogey'?2:0));
      const targetScore = h.par + adj;

      let targetTo = 0;
      let targetSZtoG = 0;
      let targetPutts = 2; // 全ケース2

      if(h.par === 3){
        if(targetScore === 3){ targetTo=1; targetSZtoG=0; }
        else if(targetScore === 4){ targetTo=1; targetSZtoG=1; }
        else if(targetScore === 5){ targetTo=1; targetSZtoG=2; }
      } else if(h.par === 4){
        if(targetScore === 4){ targetTo=2; targetSZtoG=0; }
        else if(targetScore === 5){ targetTo=2; targetSZtoG=1; }
        else if(targetScore === 6){ targetTo=2; targetSZtoG=2; }
      } else if(h.par === 5){
        if(targetScore === 5){ targetTo=2; targetSZtoG=1; }
        else if(targetScore === 6){ targetTo=3; targetSZtoG=1; }
        else if(targetScore === 7){ targetTo=3; targetSZtoG=2; }
      }

      return {targetScore, targetTo, targetSZtoG, targetPutts};
    }

    function getGrossAuto(h, round){
      const base = (h.strokesToSZ||0) + (h.strokesFromSZ||0);
      const isV2 = round && (round.schemaVersion === 'v2' || round.schemaVersion==='v3');
      if(isV2){
        return base + (h.putts||0);
      }
      return base;
    }

    /* ========== Overview ========== */
    function renderOverview(){
      const list=document.getElementById('rounds-list');
      if(state.rounds.length===0){
        list.innerHTML='<div class="p-6 bg-white rounded-xl shadow text-center text-gray-500">No rounds yet. Click "New Round".</div>';
        return;
      }
      list.innerHTML = state.rounds.map(r=>{
        const played=r.playOrder.filter(n=>{
          const h=r.holes[n-1];
          return (h.strokesToSZ||0)+(h.strokesFromSZ||0)+(h.putts||0)>0 || Number.isInteger(h.resultOverride);
        });
        const total=played.reduce((s,n)=>{
          const h=r.holes[n-1];
          const auto = getGrossAuto(h, r);
          const gross = Number.isInteger(h.resultOverride)? h.resultOverride : auto;
          return s + gross;
        },0);
        const par=played.reduce((s,n)=> s+r.holes[n-1].par,0);
        return `
          <div class="p-4 bg-white rounded-xl shadow flex items-center justify-between">
            <div>
              <div class="font-semibold">${r.courseName||'New Course'}</div>
              <div class="text-xs text-gray-500">${r.date} · Played ${played.length}/${DEFAULT_HOLES}</div>
            </div>
            <div class="text-right space-y-1">
              <div class="text-xs text-gray-500">TOTAL</div>
              <div class="text-xl font-bold">${total}</div>
              <div class="text-xs text-gray-500">vs Par</div>
              <div class="font-semibold">${pm(total-par)}</div>
              <div class="mt-2 flex gap-2 justify-end">
                <button data-open="${r.roundId}" class="px-3 py-1.5 border rounded-lg hover:bg-gray-50">Open</button>
                <button data-edit="${r.roundId}" class="px-3 py-1.5 border rounded-lg hover:bg-gray-50">Edit</button>
                <button data-export="${r.roundId}" class="px-3 py-1.5 border rounded-lg hover:bg-gray-50">Export</button>
                <button data-del="${r.roundId}" class="px-3 py-1.5 border rounded-lg text-red-600 hover:bg-red-50">Delete</button>
              </div>
            </div>
          </div>`;
      }).join('');

      list.querySelectorAll('[data-open]').forEach(b=> b.addEventListener('click',()=> openRound(b.dataset.open)));
      list.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click',()=> editRound(b.dataset.edit)));
      list.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click',()=>{
        const id=b.dataset.del;
        storage.remove(keyFor(id));
        const ids=jparse(storage.get(idxKey)||'[]',[]).filter(x=>x!==id);
        storage.set(idxKey, JSON.stringify(ids));
        loadRounds();
      }));
      list.querySelectorAll('[data-export]').forEach(b=> b.addEventListener('click',()=> exportRoundCSV(b.dataset.export)));
    }

    /* ========== Setup ========== */
    function openSetup(){
      state.round=null; state.roundId=null; state.editingId=null;
      state.parSetup=Array(DEFAULT_HOLES).fill(4); state.startOrder='OUT';
      state.setupTargets=Array(DEFAULT_HOLES).fill('Bogey');
      document.getElementById('setup-title').textContent='New Round Setup';
      document.getElementById('btn-setup-save').textContent='Start Tracker';
      document.getElementById('setup-date').value=new Date().toISOString().slice(0,10);
      document.getElementById('setup-course').value='';
      renderSetup(); switchView('setup');
    }

    function renderSetup(){
      document.getElementById('btn-start-out').classList.toggle('on', state.startOrder==='OUT');
      document.getElementById('btn-start-in').classList.toggle('on', state.startOrder==='IN');

      const grid=document.getElementById('par-input-grid');
      let html=''; let parTotal=0;

      for(let i=1;i<=DEFAULT_HOLES;i++){
        const par=state.parSetup[i-1]; parTotal+=par;
        const curTarget = state.setupTargets[i-1] || 'Bogey';

        html+=`
          <div class="flex items-center justify-between p-2 border rounded-lg mb-2">
            <div class="w-16 text-sm">H${i}</div>
            <div class="flex items-center gap-2">
              <button type="button" data-hole="${i}" data-act="-" class="px-2 py-1 bg-gray-100 rounded">-</button>
              <div class="w-8 text-center font-bold">${par}</div>
              <button type="button" data-hole="${i}" data-act="+" class="px-2 py-1 bg-gray-100 rounded">+</button>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="btn-toggle ${curTarget==='Par'?'on':''}" data-target="Par" data-hole="${i}">Par</button>
              <button type="button" class="btn-toggle ${curTarget==='Bogey'?'on':''}" data-target="Bogey" data-hole="${i}">Bogey</button>
              <button type="button" class="btn-toggle ${curTarget==='DoubleBogey'?'on':''}" data-target="DoubleBogey" data-hole="${i}">D.Bogey</button>
            </div>
          </div>`;
      }
      grid.innerHTML=html;

      const targetTotal = state.parSetup.reduce((s,p,idx)=>{
        const t = state.setupTargets[idx] || 'Bogey';
        const adj = (t==='Par'?0:(t==='Bogey'?1:2));
        return s + p + adj;
      }, 0);

      document.getElementById('setup-par-total').textContent = parTotal;
      document.getElementById('setup-target-total').textContent = targetTotal;

      grid.querySelectorAll('[data-hole][data-act]').forEach(b=> b.addEventListener('click', ()=>{
        const i=parseInt(b.dataset.hole,10)-1;
        const act=b.dataset.act;
        let v=state.parSetup[i];
        v = act==='+'? Math.min(MAX_PAR,v+1): Math.max(MIN_PAR,v-1);
        state.parSetup[i]=v; renderSetup();
      }));
      grid.querySelectorAll('[data-target]').forEach(b=> b.addEventListener('click', ()=>{
        const i=parseInt(b.dataset.hole,10)-1;
        state.setupTargets[i] = b.dataset.target;
        const group=b.parentElement.querySelectorAll('[data-target]');
        group.forEach(x=>x.classList.remove('on'));
        b.classList.add('on');
        renderSetup();
      }));
    }

    function startOrUpdateRound(){
      const date=document.getElementById('setup-date').value;
      const course=document.getElementById('setup-course').value||'New Course';

      if(state.editingId && state.round){
        const r=state.round;
        r.date = date; r.courseName = course;
        r.playStart = state.startOrder;
        r.playOrder = playOrderFor(state.startOrder);
        r.holes.forEach((h,idx)=>{
          h.par = state.parSetup[idx];
          h.targetGoal = state.setupTargets[idx] || 'Bogey';
        });
        save(); loadRounds(); openRound(state.editingId);
        return;
      }

      const id=Date.now().toString();
      const r=createRound(id,date,course,state.parSetup,state.startOrder,state.setupTargets);
      state.round=r; state.roundId=id; save(); openRound(id);
    }

    /* ========== Helpers ========== */
    const curHole = ()=> state.round.holes[state.round.playOrder[state.holeIdx-1]-1];

    function setByPath(obj, path, value){
      const parts = path.split('.');
      let ref = obj;
      for(let i=0;i<parts.length-1;i++){
        const k = parts[i];
        if(!(k in ref) || typeof ref[k] !== 'object') ref[k] = {};
        ref = ref[k];
      }
      ref[parts[parts.length-1]] = value;
    }
    function getByPath(obj, path){
      const parts = path.split('.');
      let ref = obj;
      for(const k of parts){
        if(ref==null) return undefined;
        ref = ref[k];
      }
      return ref;
    }

    // 修正10: 0 yard を除去 & Putt専用30+対応
    function populateYardSelect(id, max, value, isPutt){
      const sel = document.getElementById(id);
      if(!sel) return;

      if(!sel.dataset.initialized){
        let opts = '<option value=""></option>';

        if(isPutt){
          // Putt: 1〜30 (1刻み) + 30+
          for(let y=1; y<=30; y++){
            opts += `<option value="${y}">${y}</option>`;
          }
          opts += `<option value="30+">30+</option>`;
        } else {
          // 通常ショット: 5〜max (5刻み) / 0は不要
          for(let y=5; y<=max; y+=5){
            opts += `<option value="${y}">${y}</option>`;
          }
        }

        sel.innerHTML = opts;
        sel.dataset.initialized = '1';
      }

      sel.value = (value==null ? '' : String(value));
    }

    /* ========== Tracker ========== */
    function renderTracker(){
      const r=state.round; if(!r) return; const h=curHole();
      const holeNo=r.playOrder[state.holeIdx-1];

      const {targetScore, targetTo, targetSZtoG, targetPutts} = calcTargetsFor(h);

      const played=r.playOrder.filter(n=>{
        const x=r.holes[n-1];
        return (x.strokesToSZ||0)+(x.strokesFromSZ||0)+(x.putts||0)>0 || Number.isInteger(x.resultOverride);
      });

      const total=played.reduce((s,n)=>{
        const x=r.holes[n-1];
        const auto = getGrossAuto(x, r);
        const gross = Number.isInteger(x.resultOverride)? x.resultOverride : auto;
        return s+gross;
      },0);
      const par=played.reduce((s,n)=> s + r.holes[n-1].par, 0);
      const targetPlayed=played.reduce((s,n)=>{
        const x=r.holes[n-1];
        const {targetScore} = calcTargetsFor(x);
        return s + targetScore;
      },0);

      const totalTargetAll = r.holes.reduce((s,x)=> s + calcTargetsFor(x).targetScore, 0);

      document.getElementById('round-total').textContent = total;
      document.getElementById('round-vspar').textContent = pm(total-par);
      document.getElementById('round-vstarget').textContent = pm(total-targetPlayed);
      document.getElementById('round-total-target').textContent = totalTargetAll;

      document.getElementById('hole-title').textContent = `Hole ${holeNo} (Par ${h.par})`;
      document.getElementById('btn-prev-hole').disabled = state.holeIdx===1;
      document.getElementById('btn-next-hole').disabled = state.holeIdx===DEFAULT_HOLES;

      document.getElementById('tee-club').value=h.teeClub;
      document.querySelectorAll('.tee-res-opt').forEach(l=>{
        const on = l.dataset.value===h.teeResult;
        l.classList.toggle('on', on);
        l.classList.remove('bg-green-500','text-white','border-green-500','bg-yellow-500','border-yellow-500','bg-red-500','border-red-500');
        if(on){
          if(l.dataset.value==='Stay Course'){ l.classList.add('bg-green-500','text-white','border-green-500'); }
          else if(l.dataset.value==='Penalty'){ l.classList.add('bg-yellow-500','text-white','border-yellow-500'); }
          else if(l.dataset.value==='OB'){ l.classList.add('bg-red-500','text-white','border-red-500'); }
        }
      });
      document.querySelectorAll('.tee-dir-opt').forEach(l=>{
        const on = l.dataset.value===h.teeDirection;
        l.classList.toggle('on', on);
        l.classList.remove('bg-indigo-500','text-white','border-indigo-500');
        if(on){ l.classList.add('bg-indigo-500','text-white','border-indigo-500'); }
      });

      // To SZ / SZ to G / Putts
      document.getElementById('disp-to').textContent = h.strokesToSZ||0;
      document.getElementById('disp-from').textContent = h.strokesFromSZ||0;
      document.getElementById('disp-gtoho').textContent = h.putts||0;

      document.getElementById('target-to').textContent = targetTo;
      document.getElementById('target-from').textContent = targetSZtoG;
      document.getElementById('target-gtoho').textContent = targetPutts;

      document.getElementById('ok-to').textContent = (h.strokesToSZ||0) <= targetTo ? '✅' : '❌';
      document.getElementById('ok-from').textContent = (h.strokesFromSZ||0) <= targetSZtoG ? '✅' : '❌';
      document.getElementById('ok-gtoho').textContent = (h.putts||0) <= targetPutts ? '✅' : '❌';

      // Result override with label & warnings
      const toSz = h.strokesToSZ || 0;
      const szToG = h.strokesFromSZ || 0;
      const putts = h.putts || 0;
      const expectedTotal = toSz + szToG + putts;

      const warnEl = document.getElementById('result-warning');
      const dispRes = document.getElementById('disp-result');
      const dispResLabel = document.getElementById('disp-result-label');

      if(Number.isInteger(h.resultOverride)){
        dispRes.textContent = h.resultOverride;
        const diff = h.resultOverride - h.par;
        let label = 'Par';
        if(diff === 1) label = 'Bogey';
        else if(diff === 2) label = 'D.Bogey';
        else if(diff >= 3) label = `+${diff}`;
        else if(diff === -1) label = 'Birdie';
        else if(diff === -2) label = 'Eagle';
        else if(diff === -3) label = 'Albatross';
        else if(diff <= -4) label = `${diff}`;
        dispResLabel.textContent = `(${label})`;
      } else {
        dispRes.textContent = '';
        if(dispResLabel) dispResLabel.textContent = '';
      }

      const warnMsgs = [];
      if(Number.isInteger(h.resultOverride) && h.resultOverride!==expectedTotal){
        warnMsgs.push(`⚠️ Mismatch: To SZ + SZ to G + Putts = ${expectedTotal}, Result = ${h.resultOverride}`);
      }

    

      if(warnMsgs.length){
        warnEl.textContent = warnMsgs.join('  ');
        warnEl.className = 'text-sm text-red-600 font-semibold';
      } else {
        warnEl.textContent = '';
        warnEl.className = 'text-sm text-green-600';
      }

      // Other (To SZ) display
      document.getElementById('toSZ-ob').textContent = h.toSZ.ob||0;
      document.getElementById('toSZ-penalty').textContent = h.toSZ.penalty||0;
      document.getElementById('toSZ-bunker').textContent = h.toSZ.bunker||0;
      document.getElementById('toSZ-topped').textContent = h.toSZ.topped||0;
      document.getElementById('toSZ-heavyDuff').textContent = h.toSZ.heavyDuff||0;
      document.getElementById('toSZ-shank').textContent = h.toSZ.shank||0;

      // Target toggles
      document.getElementById('tg-par').classList.toggle('on', h.targetGoal==='Par');
      document.getElementById('tg-bogey').classList.toggle('on', h.targetGoal==='Bogey');
      document.getElementById('tg-dbogey').classList.toggle('on', h.targetGoal==='DoubleBogey');

      // Memo
      const memoEl = document.getElementById('hole-memo');
      memoEl.value = h.memo || '';
      memoEl.oninput = (e)=>{
        h.memo = e.target.value; save();
      };

      // SZ to G detail 反映
      const sgArr = Array.isArray(h.sgDetail) ? h.sgDetail : createDefaultSGDetail();
      sgArr.forEach((shot, idx)=>{
        const n = idx+1;
        populateYardSelect(`szshot${n}-target`, 120, shot.targetYard);
        populateYardSelect(`szshot${n}-actual`, 140, shot.actualYard);

        const clubSel = document.getElementById(`szshot${n}-club`);
        if(clubSel){
          clubSel.value = shot.club || '';
        }

        const outs = Array.isArray(shot.outcomes) ? shot.outcomes : [];
        document.querySelectorAll(`.szdetail-outcome[data-shot="${n}"]`).forEach(l=>{
          const on = outs.includes(l.dataset.val);
          l.classList.toggle('on', on);
        });
      });

      // Putt Detail 反映
      const pArr = Array.isArray(h.puttDetail)? h.puttDetail : createDefaultPuttDetail();
      pArr.forEach((p, idx)=>{
        const n = idx+1;
        populateYardSelect(`putt${n}-target`, 50, p.targetYard, true);

        // Result（単一）
        document.querySelectorAll(`.puttdetail-result[data-putt="${n}"]`).forEach(lbl=>{
          const on = (p.result === lbl.dataset.val);
          lbl.classList.toggle('on', on);
        });

        // Stroke（複数）
        const strokes = Array.isArray(p.stroke)? p.stroke : [];
        document.querySelectorAll(`.puttdetail-stroke[data-putt="${n}"]`).forEach(lbl=>{
          const on = strokes.includes(lbl.dataset.val);
          lbl.classList.toggle('on', on);
        });

        // Read（単一）
        document.querySelectorAll(`.puttdetail-read[data-putt="${n}"]`).forEach(lbl=>{
          const on = (p.read === lbl.dataset.val);
          lbl.classList.toggle('on', on);
        });
      });
    }

    function updateHole(key, val){ const h=curHole(); setByPath(h, key, val); save(); renderTracker(); }

    // 「最初の＋」でターゲット値を入れるインクリメント
    function inc(key, delta){
      const h = curHole();
      const {targetScore, targetTo, targetSZtoG, targetPutts} = calcTargetsFor(h);

      const baseRaw = getByPath(h, key);
      const base = (baseRaw==null ? 0 : baseRaw);
      let v;
      if (delta > 0 && (baseRaw==null || base===0)) {
        if (key === 'resultOverride')      v = targetScore;
        else if (key === 'strokesToSZ')    v = targetTo;
        else if (key === 'strokesFromSZ')  v = (targetSZtoG === 0 ? 1 : targetSZtoG);
        else if (key === 'putts')          v = targetPutts;
        else                               v = 1;
      } else {
        v = Math.max(0, (base||0) + delta);
      }
      setByPath(h, key, v);
      save(); renderTracker();
    }

    function moveHole(d){ const n=state.holeIdx + d; if(n<1||n>DEFAULT_HOLES) return; state.holeIdx=n; renderTracker(); }

    /* ========== Scorecard Helpers ========== */
    function isPlayedHole(h){
      return (h.strokesToSZ||0)+(h.strokesFromSZ||0)+(h.putts||0)>0 || Number.isInteger(h.resultOverride);
    }

    // 修正11・12対応: vsTargetはプレー済みホールのみ / GIRは数で返す
    function computeSegmentSummary(r, filterFn){
      let total=0, par=0, target=0, putts=0, played=0;
      let girCount=0, gir1Count=0;

      r.playOrder.forEach(no=>{
        if(!filterFn(no)) return;
        const h=r.holes[no-1];
        const playedThis = isPlayedHole(h);
        if(!playedThis) return;

        played++;
        const auto = getGrossAuto(h, r);
        const gross = Number.isInteger(h.resultOverride)? h.resultOverride : auto;
        total += gross;
        par   += h.par;

        const {targetScore} = calcTargetsFor(h);
        target += targetScore;
        putts  += (h.putts||0);

        const strokesToGreen = (h.strokesToSZ||0)+(h.strokesFromSZ||0);
        if(strokesToGreen>0){
          if(strokesToGreen <= h.par-2) girCount++;
          else if(strokesToGreen <= h.par-1) gir1Count++;
        }
      });

      return {
        total, par, target, putts, played,
        vsPar: total-par,
        vsTarget: total-target,
        gir: girCount,
        girAnd: girCount + gir1Count
      };
    }

    /* ========== Scorecard ========== */
    function openScorecard(){ renderScorecard(); switchView('scorecard'); }

    function renderScorecard(){
      const r=state.round; if(!r) return;

      const allSummary = computeSegmentSummary(r, no => isPlayedHole(r.holes[no - 1]));
// ==== 修正：OUT / IN は常に全ホールの TargetScore を合計して表示 ====

// OUT 9ホールすべての TargetScore
const outTarget = r.holes
  .slice(0,9)
  .reduce((s,h)=> s + calcTargetsFor(h).targetScore, 0);

// IN 9ホールすべての TargetScore
const inTarget = r.holes
  .slice(9,18)
  .reduce((s,h)=> s + calcTargetsFor(h).targetScore, 0);

// 既存 summary（played だけ計算されるが target は後で上書き）
const outSummary = computeSegmentSummary(r, no=>no>=1 && no<=9, 9);
const inSummary  = computeSegmentSummary(r, no=>no>=10 && no<=18, 9);

// Target の値を “全ホール合計” に上書き
outSummary.target = outTarget;
inSummary.target  = inTarget;

      const totalTargetAll = r.holes.reduce((s,x)=> s + calcTargetsFor(x).targetScore, 0);

      document.getElementById('sc-summary').innerHTML =
        `<div class="space-y-2">
          <div class="grid grid-cols-8 gap-2 text-right">
            <div><div class='grid-head'>Total</div><div class='font-bold'>${allSummary.total}</div></div>
            <div><div class='grid-head'>vs Par</div><div class='font-bold'>${pm(allSummary.vsPar)}</div></div>
            <div><div class='grid-head'>vs Target</div><div class='font-bold'>${pm(allSummary.vsTarget)}</div></div>
            <div><div class='grid-head'>Total Target</div><div class='font-bold'>${totalTargetAll}</div></div>
            <div><div class='grid-head'>Putts</div><div class='font-bold'>${allSummary.putts}</div></div>
            <div><div class='grid-head'>Played</div><div class='font-bold'>${allSummary.played}/${DEFAULT_HOLES}</div></div>
            <div><div class='grid-head'>GIR</div><div class='font-bold'>${allSummary.gir}</div></div>
            <div><div class='grid-head'>GIR&+1</div><div class='font-bold'>${allSummary.girAnd}</div></div>
          </div>
          <div class="grid grid-cols-8 gap-2 text-right">
            <div><div class='grid-head'>OUT Total</div><div class='font-bold'>${outSummary.total}</div></div>
            <div><div class='grid-head'>OUT vs Par</div><div class='font-bold'>${pm(outSummary.vsPar)}</div></div>
            <div><div class='grid-head'>OUT vs Target</div><div class='font-bold'>${pm(outSummary.vsTarget)}</div></div>
            <div><div class='grid-head'>OUT Target</div><div class='font-bold'>${outSummary.target}</div></div>
            <div><div class='grid-head'>OUT Putts</div><div class='font-bold'>${outSummary.putts}</div></div>
            <div><div class='grid-head'>OUT Played</div><div class='font-bold'>${outSummary.played}/9</div></div>
            <div><div class='grid-head'>OUT GIR</div><div class='font-bold'>${outSummary.gir}</div></div>
            <div><div class='grid-head'>OUT GIR&+1</div><div class='font-bold'>${outSummary.girAnd}</div></div>
          </div>
          <div class="grid grid-cols-8 gap-2 text-right">
            <div><div class='grid-head'>IN Total</div><div class='font-bold'>${inSummary.total}</div></div>
            <div><div class='grid-head'>IN vs Par</div><div class='font-bold'>${pm(inSummary.vsPar)}</div></div>
            <div><div class='grid-head'>IN vs Target</div><div class='font-bold'>${pm(inSummary.vsTarget)}</div></div>
            <div><div class='grid-head'>IN Target</div><div class='font-bold'>${inSummary.target}</div></div>
            <div><div class='grid-head'>IN Putts</div><div class='font-bold'>${inSummary.putts}</div></div>
            <div><div class='grid-head'>IN Played</div><div class='font-bold'>${inSummary.played}/9</div></div>
            <div><div class='grid-head'>IN GIR</div><div class='font-bold'>${inSummary.gir}</div></div>
            <div><div class='grid-head'>IN GIR&+1</div><div class='font-bold'>${inSummary.girAnd}</div></div>
          </div>
        </div>`;

      const tbody=document.getElementById('sc-tbody');
      tbody.innerHTML = r.playOrder.map(no=>{
        const h=r.holes[no-1];
        const {targetScore, targetTo, targetSZtoG, targetPutts} = calcTargetsFor(h);
        const grossAuto = getGrossAuto(h, r);
        const gross = Number.isInteger(h.resultOverride)? h.resultOverride : grossAuto;
        const expectedTotal = (h.strokesToSZ||0) + (h.strokesFromSZ||0) + (h.putts||0);
        const mismatch = Number.isInteger(h.resultOverride) && h.resultOverride!==expectedTotal;
        const okTo=(h.strokesToSZ||0) <= targetTo;
        const okSZtoG=(h.strokesFromSZ||0) <= targetSZtoG;
        const okGtoHO=(h.putts||0) <= targetPutts;

        const strokesToGreen = (h.strokesToSZ||0)+(h.strokesFromSZ||0);
        let girLabel = '';
        if (strokesToGreen > 0) {
          if (strokesToGreen <= h.par - 2) {
            girLabel = `
              <div class="flex items-center justify-center gap-1">
                <span class="inline-block w-3 h-3 rounded-full bg-blue-500"></span>
                <span class="text-blue-600 font-semibold text-xs">GIR</span>
              </div>
            `;
          } else if (strokesToGreen <= h.par - 1) {
            girLabel = `
              <div class="flex items-center justify-center gap-1">
                <span class="text-green-600 text-sm">✅</span>
                <span class="text-green-600 font-semibold text-xs">GIR+1</span>
              </div>
            `;
          }
        }

        const diffVsPar = targetScore - h.par;
        let targetDisplay = 'E';
        if (diffVsPar > 0) targetDisplay = `+${diffVsPar}`;
        else if (diffVsPar < 0) targetDisplay = `${diffVsPar}`;

        return `<tr class="hover:bg-gray-50 ${gross===0?'opacity-50':''}" data-goto="${no}">
          <td class="p-2">${no}</td>
          <td class="p-2">${h.par}</td>
          <td class="p-2">${targetDisplay}</td>
          <td class="p-2 ${okTo?'score-ok':'score-ng'}">
            ${h.strokesToSZ||0}
            <span class="text-gray-400 text-xs">(T=${targetTo})</span>
            ${okTo?'✅':'❌'}
          </td>
          <td class="p-2 ${okSZtoG?'score-ok':'score-ng'}">
            ${h.strokesFromSZ||0}
            <span class="text-gray-400 text-xs">(T=${targetSZtoG})</span>
            ${okSZtoG?'✅':'❌'}
          </td>
          <td class="p-2 ${okGtoHO?'score-ok':'score-ng'}">
            ${h.putts||0}
            <span class="text-gray-400 text-xs">(T=${targetPutts})</span>
            ${okGtoHO?'✅':'❌'}
          </td>
          <td class="p-2 font-semibold">${gross||''} ${mismatch?'⚠️':''}</td>
          <td class="p-2">${pm(gross-targetScore)}</td>
          <td class="p-2 text-center">${girLabel}</td>
        </tr>`;
      }).join('');

      document.querySelectorAll('#sc-tbody [data-goto]').forEach(tr=>{
        tr.addEventListener('click', ()=>{
          const no=parseInt(tr.getAttribute('data-goto'),10);
          const idx = state.round.playOrder.indexOf(no);
          if(idx>=0){ state.holeIdx = idx+1; switchView('tracker'); renderTracker(); }
        });
      });
    }

    /* ========== CSV Export (per round) ========== */
    function exportRoundCSV(id){
      const raw = storage.get(keyFor(id));
      if(!raw){ alert('Round not found.'); return; }
      const r = upgradeRoundIfNeeded(jparse(raw,null)); if(!r){ alert('Invalid round data.'); return; }

      const rows = [[
        'Hole','Par','TargetScore','ToSZ','SZtoG','Putts','Gross',
        'TeeClub','TeeResult','TeeDirection',
        'ToSZ_OB','ToSZ_Penalty','ToSZ_Bunker','ToSZ_Topped','ToSZ_HeavyDuff','ToSZ_Shank',
        'SZtoG_OB','SZtoG_Penalty','SZtoG_Bunker','SZtoG_Topped','SZtoG_HeavyDuff','SZtoG_Shank',
        'Shot1_TargetYard','Shot1_Club','Shot1_ActualYard','Shot1_Outcomes',
        'Shot2_TargetYard','Shot2_Club','Shot2_ActualYard','Shot2_Outcomes',
        'Shot3_TargetYard','Shot3_Club','Shot3_ActualYard','Shot3_Outcomes',
        'Putt1_TargetYard','Putt1_Stroke','Putt1_Result','Putt1_Read',
        'Putt2_TargetYard','Putt2_Stroke','Putt2_Result','Putt2_Read',
        'Putt3_TargetYard','Putt3_Stroke','Putt3_Result','Putt3_Read',
        'Putt4_TargetYard','Putt4_Stroke','Putt4_Result','Putt4_Read',
        'vsTarget','vsPar','GIRLabel','Memo'
      ]];

      r.playOrder.forEach(no=>{
        const h = r.holes[no-1];
        const {targetScore} = calcTargetsFor(h);
        const grossAuto = getGrossAuto(h, r);
        const gross = Number.isInteger(h.resultOverride)? h.resultOverride : grossAuto;

        const strokesToGreen = (h.strokesToSZ||0)+(h.strokesFromSZ||0);
        let girLabel = '';
        if(strokesToGreen>0){
          if(strokesToGreen <= h.par-2) girLabel = 'GIR';
          else if(strokesToGreen <= h.par-1) girLabel = 'GIR+1';
        }

        const sgArr = Array.isArray(h.sgDetail) ? h.sgDetail : createDefaultSGDetail();
        const s1 = sgArr[0] || {};
        const s2 = sgArr[1] || {};
        const s3 = sgArr[2] || {};

        const s1Out = Array.isArray(s1.outcomes) ? s1.outcomes.join(';') : '';
        const s2Out = Array.isArray(s2.outcomes) ? s2.outcomes.join(';') : '';
        const s3Out = Array.isArray(s3.outcomes) ? s3.outcomes.join(';') : '';

        const pArr = Array.isArray(h.puttDetail)? h.puttDetail : createDefaultPuttDetail();
        const puttCells = pArr.slice(0,4).map(p=>{
          const strokeStr = Array.isArray(p.stroke)? p.stroke.join(';') : '';
          return [
            p.targetYard==null ? '' : p.targetYard,
            strokeStr,
            p.result || '',
            p.read || ''
          ];
        }).flat();

        rows.push([
          no, h.par, targetScore,
          (h.strokesToSZ||0),
          (h.strokesFromSZ||0),
          (h.putts||0),
          gross,
          h.teeClub, h.teeResult, h.teeDirection,
          (h.toSZ.ob||0),(h.toSZ.penalty||0),(h.toSZ.bunker||0),(h.toSZ.topped||0),(h.toSZ.heavyDuff||0),(h.toSZ.shank||0),
          (h.szToG.ob||0),(h.szToG.penalty||0),(h.szToG.bunker||0),(h.szToG.topped||0),(h.szToG.heavyDuff||0),(h.szToG.shank||0),
          (s1.targetYard==null?'':s1.targetYard),(s1.club||''),(s1.actualYard==null?'':s1.actualYard),s1Out,
          (s2.targetYard==null?'':s2.targetYard),(s2.club||''),(s2.actualYard==null?'':s2.actualYard),s2Out,
          (s3.targetYard==null?'':s3.targetYard),(s3.club||''),(s3.actualYard==null?'':s3.actualYard),s3Out,
          ...puttCells,
          (gross-targetScore),(gross-h.par),
          girLabel,
          h.memo || ''
        ]);
      });

      const csv = rows.map(r=>r.map(x=>String(x).replace(/"/g,'""')).map(x=>`"${x}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `round_${r.roundId}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    /* ========== Events ========== */
    function bindEvents(){
      // Overview
      document.getElementById('btn-new-round').addEventListener('click', openSetup);

      // Setup
      document.getElementById('btn-setup-cancel').addEventListener('click', ()=> switchView('overview'));
      document.getElementById('btn-setup-save').addEventListener('click', startOrUpdateRound);
      document.getElementById('btn-start-out').addEventListener('click', ()=>{ state.startOrder='OUT'; renderSetup(); });
      document.getElementById('btn-start-in').addEventListener('click', ()=>{ state.startOrder='IN'; renderSetup(); });

      // Tracker
      document.getElementById('btn-tracker-back').addEventListener('click', ()=> switchView('overview'));
      document.getElementById('btn-open-scorecard').addEventListener('click', openScorecard);
      document.getElementById('btn-prev-hole').addEventListener('click', ()=> moveHole(-1));
      document.getElementById('btn-next-hole').addEventListener('click', ()=> moveHole(1));

      document.getElementById('tee-club').addEventListener('change', (e)=> updateHole('teeClub', e.target.value));
      document.querySelectorAll('.tee-res-opt').forEach(l=> l.addEventListener('click', ()=> updateHole('teeResult', l.dataset.value)));
      document.querySelectorAll('.tee-dir-opt').forEach(l=> l.addEventListener('click', ()=> updateHole('teeDirection', l.dataset.value)));

      // +/- counters
      document.querySelectorAll('[data-key][data-act]').forEach(b=> b.addEventListener('click', ()=> inc(b.dataset.key, b.dataset.act==='+'?1:-1)));

      // Target toggle
      document.getElementById('tg-par').addEventListener('click', ()=> updateHole('targetGoal','Par'));
      document.getElementById('tg-bogey').addEventListener('click', ()=> updateHole('targetGoal','Bogey'));
      document.getElementById('tg-dbogey').addEventListener('click', ()=> updateHole('targetGoal','DoubleBogey'));

      // Scorecard back
      document.getElementById('btn-scorecard-back').addEventListener('click', ()=> switchView('tracker'));

      // SZ to G detail select
      document.querySelectorAll('.szdetail-select').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          const shot = parseInt(sel.dataset.shot,10);
          const field = sel.dataset.field;
          if(!shot || !field) return;
          const idx = shot-1;
          const h = curHole();
          if(!Array.isArray(h.sgDetail)) h.sgDetail = createDefaultSGDetail();
          if(!h.sgDetail[idx]) h.sgDetail[idx] = { targetYard:null, club:'', actualYard:null, outcomes:[] };

          let val = sel.value;
          if(field === 'targetYard' || field === 'actualYard'){
            val = val === '' ? null : Number(val);
          }
          h.sgDetail[idx][field] = val;
          save(); renderTracker();
        });
      });

      // SZ to G Outcomes pill
      document.querySelectorAll('.szdetail-outcome').forEach(lbl=>{
        lbl.addEventListener('click', ()=>{
          const shot = parseInt(lbl.dataset.shot,10);
          const val = lbl.dataset.val;
          if(!shot || !val) return;
          const idx = shot-1;
          const h = curHole();
          if(!Array.isArray(h.sgDetail)) h.sgDetail = createDefaultSGDetail();
          if(!h.sgDetail[idx]) h.sgDetail[idx] = { targetYard:null, club:'', actualYard:null, outcomes:[] };

          const arr = Array.isArray(h.sgDetail[idx].outcomes) ? h.sgDetail[idx].outcomes : [];
          const i = arr.indexOf(val);
          if(i>=0) arr.splice(i,1); else arr.push(val);
          h.sgDetail[idx].outcomes = arr;
          save(); renderTracker();
        });
      });

      // Putt Detail: Target yard
      document.querySelectorAll('.puttdetail-select').forEach(sel=>{
        sel.addEventListener('change', ()=>{
          const putt = parseInt(sel.dataset.putt,10)-1;
          const field = sel.dataset.field;
          const h = curHole();
          if(!Array.isArray(h.puttDetail)) h.puttDetail = createDefaultPuttDetail();
          if(!h.puttDetail[putt]) h.puttDetail[putt] = { targetYard:null, stroke:[], result:null, read:null };

          let val = sel.value;
          if(val === '') val = null;
          h.puttDetail[putt][field] = val;
          save(); renderTracker();
        });
      });

      // Putt Detail: Result（単一）
      document.querySelectorAll('.puttdetail-result').forEach(lbl=>{
        lbl.addEventListener('click', ()=>{
          const putt = parseInt(lbl.dataset.putt,10)-1;
          const val = lbl.dataset.val;
          const h = curHole();
          if(!Array.isArray(h.puttDetail)) h.puttDetail = createDefaultPuttDetail();
          if(!h.puttDetail[putt]) h.puttDetail[putt] = { targetYard:null, stroke:[], result:null, read:null };

          h.puttDetail[putt].result = val;
          save(); renderTracker();
        });
      });

      // Putt Detail: Stroke（複数）
      document.querySelectorAll('.puttdetail-stroke').forEach(lbl=>{
        lbl.addEventListener('click', ()=>{
          const putt = parseInt(lbl.dataset.putt,10)-1;
          const val = lbl.dataset.val;
          const h = curHole();
          if(!Array.isArray(h.puttDetail)) h.puttDetail = createDefaultPuttDetail();
          if(!h.puttDetail[putt]) h.puttDetail[putt] = { targetYard:null, stroke:[], result:null, read:null };

          const arr = Array.isArray(h.puttDetail[putt].stroke) ? h.puttDetail[putt].stroke : [];
          const idx = arr.indexOf(val);
          if(idx>=0) arr.splice(idx,1); else arr.push(val);
          h.puttDetail[putt].stroke = arr;
          save(); renderTracker();
        });
      });

      // Putt Detail: Read（単一）
      document.querySelectorAll('.puttdetail-read').forEach(lbl=>{
        lbl.addEventListener('click', ()=>{
          const putt = parseInt(lbl.dataset.putt,10)-1;
          const val = lbl.dataset.val;
          const h = curHole();
          if(!Array.isArray(h.puttDetail)) h.puttDetail = createDefaultPuttDetail();
          if(!h.puttDetail[putt]) h.puttDetail[putt] = { targetYard:null, stroke:[], result:null, read:null };

          h.puttDetail[putt].read = val;
          save(); renderTracker();
        });
      });
    }

    /* ========== Init ========== */
    (function init(){
      bindEvents();
      loadRounds();
    })();
  </script>
</body>
</html>
